# üîó Next.js Ïó∞Îèô Í≥ÑÌöç (Integration Plan)

## üìå Í∞úÏöî

Í∏∞Ï°¥ Next.js ÌîÑÎ°úÏ†ùÌä∏ÏôÄ ÏÉàÎ°úÏö¥ InsightFace Î∞±ÏóîÎìúÎ•º ÌïòÏù¥Î∏åÎ¶¨ÎìúÎ°ú Ïó∞ÎèôÌïòÍ∏∞ ÏúÑÌïú ÏÉÅÏÑ∏ Í≥ÑÌöçÏûÖÎãàÎã§. Î¨¥Ï§ëÎã® ÏÑúÎπÑÏä§ÏôÄ Ï†êÏßÑÏ†Å Ï†ÑÌôòÏùÑ Î™©ÌëúÎ°ú Ìï©ÎãàÎã§.

## üéØ Ïó∞Îèô Ï†ÑÎûµ

### 1. ÌïòÏù¥Î∏åÎ¶¨Îìú ÏïÑÌÇ§ÌÖçÏ≤ò

```mermaid
graph TB
    A[Next.js Frontend] --> B[API Route Layer]
    B --> C{Environment Switch}
    C -->|USE_INSIGHT_FACE=false| D[AWS Rekognition]
    C -->|USE_INSIGHT_FACE=true| E[InsightFace Backend]
    E --> F[FastAPI Server]
    F --> G[InsightFace Models]
```

### 2. Ï†ÑÌôò Îã®Í≥Ñ

```
Phase 1: Í∞úÎ∞úÌôòÍ≤Ω Íµ¨Ï∂ï (1Ï£º)
‚îú‚îÄ‚îÄ Python Î∞±ÏóîÎìú Î°úÏª¨ Í∞úÎ∞ú
‚îú‚îÄ‚îÄ Í∏∞Î≥∏ API Íµ¨ÌòÑ
‚îî‚îÄ‚îÄ Îã®ÏúÑ ÌÖåÏä§Ìä∏

Phase 2: Ïó∞Îèô Íµ¨ÌòÑ (3Ïùº)
‚îú‚îÄ‚îÄ Next.js API Routes ÏàòÏ†ï
‚îú‚îÄ‚îÄ ÌôòÍ≤ΩÎ≥ÄÏàò Í∏∞Î∞ò ÎùºÏö∞ÌåÖ
‚îî‚îÄ‚îÄ ÏùëÎãµ Ìè¨Îß∑ ÌëúÏ§ÄÌôî

Phase 3: ÌÖåÏä§Ìä∏ Î∞è Í≤ÄÏ¶ù (2Ïùº)
‚îú‚îÄ‚îÄ Í∏∞Îä• ÎèôÎì±ÏÑ± Í≤ÄÏ¶ù
‚îú‚îÄ‚îÄ ÏÑ±Îä• ÎπÑÍµê ÌÖåÏä§Ìä∏
‚îî‚îÄ‚îÄ ÏóêÎü¨ Ï≤òÎ¶¨ Í≤ÄÏ¶ù

Phase 4: Ï†êÏßÑÏ†Å Î∞∞Ìè¨ (1Ï£º)
‚îú‚îÄ‚îÄ Í∞úÎ∞úÏûê ÌÖåÏä§Ìä∏ (100% InsightFace)
‚îú‚îÄ‚îÄ A/B ÌÖåÏä§Ìä∏ (50/50)
‚îú‚îÄ‚îÄ Îã®Í≥ÑÏ†Å Ï†ÑÌôò (80/20, 90/10, 100/0)
‚îî‚îÄ‚îÄ AWS ÏôÑÏ†Ñ ÎåÄÏ≤¥
```

## üîß Íµ¨ÌòÑ ÏÑ∏Î∂ÄÏÇ¨Ìï≠

### 1. ÌôòÍ≤ΩÎ≥ÄÏàò ÏÑ§Ï†ï

#### `.env.local` ÏóÖÎç∞Ïù¥Ìä∏
```env
# Í∏∞Ï°¥ AWS ÏÑ§Ï†ï
AWS_ACCESS_KEY_ID=your-aws-key
AWS_SECRET_ACCESS_KEY=your-aws-secret
AWS_REGION=ap-northeast-2

# ÏÉàÎ°úÏö¥ InsightFace ÏÑ§Ï†ï
USE_INSIGHT_FACE=false                    # trueÎ°ú Î≥ÄÍ≤ΩÏãú InsightFace ÏÇ¨Ïö©
INSIGHT_FACE_API_URL=http://localhost:8000
INSIGHT_FACE_API_KEY=your-api-key         # ÏÑ†ÌÉùÏÇ¨Ìï≠
INSIGHT_FACE_TIMEOUT=30000                # 30Ï¥à ÌÉÄÏûÑÏïÑÏõÉ

# ÌïòÏù¥Î∏åÎ¶¨Îìú ÏÑ§Ï†ï
FALLBACK_TO_AWS=true                      # InsightFace Ïã§Ìå®Ïãú AWS ÏÇ¨Ïö©
A_B_TEST_RATIO=0.0                        # 0.0=AWSÎßå, 1.0=InsightFaceÎßå
LOG_COMPARISON=true                       # Í≤∞Í≥º ÎπÑÍµê Î°úÍπÖ
```

### 2. Next.js API Routes ÏàòÏ†ï

#### Í≥µÌÜµ Ïú†Ìã∏Î¶¨Ìã∞ ÏÉùÏÑ±
```typescript
// src/lib/ai-service-router.ts
export interface FaceComparisonRequest {
  sourceImage: string;
  targetImage: string;
  similarityThreshold?: number;
}

export interface FaceComparisonResponse {
  success: boolean;
  data?: {
    similarity: number;
    faceMatches: any[];
    sourceImageFace?: any;
    unmatchedFaces: any[];
  };
  error?: string;
  metadata?: {
    provider: 'aws' | 'insightface';
    processingTimeMs: number;
  };
}

class AIServiceRouter {
  private useInsightFace: boolean;
  private fallbackToAWS: boolean;
  private abTestRatio: number;

  constructor() {
    this.useInsightFace = process.env.USE_INSIGHT_FACE === 'true';
    this.fallbackToAWS = process.env.FALLBACK_TO_AWS === 'true';
    this.abTestRatio = parseFloat(process.env.A_B_TEST_RATIO || '0');
  }

  private shouldUseInsightFace(userId?: string): boolean {
    // A/B ÌÖåÏä§Ìä∏ Î°úÏßÅ
    if (this.abTestRatio > 0) {
      const userHash = userId ? this.hashUserId(userId) : Math.random();
      return userHash < this.abTestRatio;
    }
    
    return this.useInsightFace;
  }

  private hashUserId(userId: string): number {
    // ÏùºÍ¥ÄÎêú Ìï¥Ïãú Ìï®Ïàò (Í∞ôÏùÄ ÏÇ¨Ïö©ÏûêÎäî Ìï≠ÏÉÅ Í∞ôÏùÄ Í≤∞Í≥º)
    let hash = 0;
    for (let i = 0; i < userId.length; i++) {
      const char = userId.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash;
    }
    return Math.abs(hash) / 2147483647;
  }

  async compareFaces(
    request: FaceComparisonRequest,
    userId?: string
  ): Promise<FaceComparisonResponse> {
    const startTime = Date.now();
    const useInsightFace = this.shouldUseInsightFace(userId);

    try {
      if (useInsightFace) {
        const result = await this.callInsightFace(request);
        result.metadata = {
          provider: 'insightface',
          processingTimeMs: Date.now() - startTime
        };
        return result;
      } else {
        const result = await this.callAWS(request);
        result.metadata = {
          provider: 'aws',
          processingTimeMs: Date.now() - startTime
        };
        return result;
      }
    } catch (error) {
      console.error(`Error with ${useInsightFace ? 'InsightFace' : 'AWS'}:`, error);
      
      // Fallback Î°úÏßÅ
      if (useInsightFace && this.fallbackToAWS) {
        console.log('Falling back to AWS Rekognition');
        try {
          const result = await this.callAWS(request);
          result.metadata = {
            provider: 'aws',
            processingTimeMs: Date.now() - startTime
          };
          return result;
        } catch (fallbackError) {
          console.error('Fallback to AWS also failed:', fallbackError);
        }
      }

      return {
        success: false,
        error: error instanceof Error ? error.message : 'Unknown error',
        metadata: {
          provider: useInsightFace ? 'insightface' : 'aws',
          processingTimeMs: Date.now() - startTime
        }
      };
    }
  }

  private async callInsightFace(request: FaceComparisonRequest): Promise<FaceComparisonResponse> {
    const apiUrl = process.env.INSIGHT_FACE_API_URL;
    const apiKey = process.env.INSIGHT_FACE_API_KEY;
    const timeout = parseInt(process.env.INSIGHT_FACE_TIMEOUT || '30000');

    const headers: Record<string, string> = {
      'Content-Type': 'application/json',
    };

    if (apiKey) {
      headers['X-API-Key'] = apiKey;
    }

    const response = await fetch(`${apiUrl}/compare-faces`, {
      method: 'POST',
      headers,
      body: JSON.stringify({
        source_image: request.sourceImage,
        target_image: request.targetImage,
        similarity_threshold: request.similarityThreshold || 0.01
      }),
      signal: AbortSignal.timeout(timeout)
    });

    if (!response.ok) {
      throw new Error(`InsightFace API error: ${response.status} ${response.statusText}`);
    }

    const result = await response.json();
    
    // InsightFace ÏùëÎãµÏùÑ AWS Ìè¨Îß∑ÏúºÎ°ú Î≥ÄÌôò
    return this.convertInsightFaceToAWS(result);
  }

  private async callAWS(request: FaceComparisonRequest): Promise<FaceComparisonResponse> {
    // Í∏∞Ï°¥ AWS Rekognition Ìò∏Ï∂ú Î°úÏßÅ
    const { compareFaces } = await import('@/lib/aws/rekognition');
    return await compareFaces(
      request.sourceImage,
      request.targetImage,
      request.similarityThreshold
    );
  }

  private convertInsightFaceToAWS(insightFaceResult: any): FaceComparisonResponse {
    if (!insightFaceResult.success) {
      return {
        success: false,
        error: insightFaceResult.error?.message || 'InsightFace processing failed'
      };
    }

    const data = insightFaceResult.data;
    
    return {
      success: true,
      data: {
        similarity: data.similarity * 100, // 0-1 ‚Üí 0-100 Î≥ÄÌôò
        faceMatches: data.face_matches?.map((match: any) => ({
          similarity: match.similarity * 100,
          face: {
            boundingBox: {
              width: match.bounding_box.width,
              height: match.bounding_box.height,
              left: match.bounding_box.x,
              top: match.bounding_box.y
            },
            confidence: match.confidence * 100
          }
        })) || [],
        sourceImageFace: data.source_face ? {
          boundingBox: {
            width: data.source_face.bounding_box.width,
            height: data.source_face.bounding_box.height,
            left: data.source_face.bounding_box.x,
            top: data.source_face.bounding_box.y
          },
          confidence: data.source_face.confidence * 100
        } : undefined,
        unmatchedFaces: data.target_faces?.filter((face: any) => 
          !data.face_matches?.some((match: any) => 
            Math.abs(match.bounding_box.x - face.bounding_box.x) < 10
          )
        ).map((face: any) => ({
          boundingBox: {
            width: face.bounding_box.width,
            height: face.bounding_box.height,
            left: face.bounding_box.x,
            top: face.bounding_box.y
          },
          confidence: face.confidence * 100
        })) || []
      }
    };
  }
}

export const aiServiceRouter = new AIServiceRouter();
```

#### API Routes ÏóÖÎç∞Ïù¥Ìä∏

```typescript
// src/app/api/rekognition/compare-faces/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { aiServiceRouter } from '@/lib/ai-service-router';

export async function POST(request: NextRequest) {
  try {
    const { sourceImage, targetImage, similarityThreshold } = await request.json();
    const userId = request.headers.get('x-user-id'); // ÏÑ†ÌÉùÏÇ¨Ìï≠

    console.log('=== Compare Faces API Called ===');
    console.log('Source image length:', sourceImage?.length);
    console.log('Target image length:', targetImage?.length);
    console.log('Similarity threshold:', similarityThreshold);

    if (!sourceImage || !targetImage) {
      return NextResponse.json(
        { success: false, error: 'Both source and target images are required' },
        { status: 400 }
      );
    }

    // AI ÏÑúÎπÑÏä§ ÎùºÏö∞ÌÑ∞Î•º ÌÜµÌï¥ Ï≤òÎ¶¨
    const result = await aiServiceRouter.compareFaces({
      sourceImage,
      targetImage,
      similarityThreshold
    }, userId || undefined);

    console.log('AI Service result:', JSON.stringify(result, null, 2));

    // ÏÇ¨Ïö©Îüâ Ï∂îÏ†Å (Í∏∞Ï°¥ Î°úÏßÅ Ïú†ÏßÄ)
    if (result.success) {
      try {
        await fetch(`${process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000'}/api/monitoring/usage`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            operation: 'compareFaces',
            provider: result.metadata?.provider 
          }),
        });
      } catch (trackingError) {
        console.warn('Failed to track usage:', trackingError);
      }
    }

    if (!result.success) {
      return NextResponse.json(
        { success: false, error: result.error },
        { status: 500 }
      );
    }

    return NextResponse.json(result);
  } catch (error) {
    console.error('Error in compare-faces API:', error);
    return NextResponse.json(
      { success: false, error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```

### 3. Î™®ÎãàÌÑ∞ÎßÅ Î∞è Î°úÍπÖ

#### ÎπÑÍµê Î°úÍπÖ ÏãúÏä§ÌÖú
```typescript
// src/lib/comparison-logger.ts
interface ComparisonLog {
  requestId: string;
  timestamp: Date;
  sourceImageHash: string;
  targetImageHash: string;
  awsResult?: any;
  insightFaceResult?: any;
  similarityDiff?: number;
  processingTimeDiff?: number;
  error?: string;
}

class ComparisonLogger {
  private logs: ComparisonLog[] = [];

  async logComparison(
    requestId: string,
    sourceImage: string,
    targetImage: string,
    awsResult?: any,
    insightFaceResult?: any
  ) {
    if (process.env.LOG_COMPARISON !== 'true') return;

    const log: ComparisonLog = {
      requestId,
      timestamp: new Date(),
      sourceImageHash: this.hashImage(sourceImage),
      targetImageHash: this.hashImage(targetImage),
      awsResult,
      insightFaceResult
    };

    if (awsResult?.success && insightFaceResult?.success) {
      log.similarityDiff = Math.abs(
        awsResult.data.similarity - insightFaceResult.data.similarity
      );
      log.processingTimeDiff = Math.abs(
        (awsResult.metadata?.processingTimeMs || 0) - 
        (insightFaceResult.metadata?.processingTimeMs || 0)
      );
    }

    this.logs.push(log);
    
    // ÌååÏùºÏóê Î°úÍ∑∏ Ï†ÄÏû•
    await this.writeToFile(log);
  }

  private hashImage(imageData: string): string {
    // Ïù¥ÎØ∏ÏßÄ Ìï¥Ïãú ÏÉùÏÑ± (Í∞úÏù∏Ï†ïÎ≥¥ Î≥¥Ìò∏)
    const crypto = require('crypto');
    return crypto.createHash('sha256').update(imageData).digest('hex').substring(0, 16);
  }

  private async writeToFile(log: ComparisonLog) {
    const fs = require('fs').promises;
    const logDir = './logs/comparison';
    
    try {
      await fs.mkdir(logDir, { recursive: true });
      await fs.appendFile(
        `${logDir}/comparison-${new Date().toISOString().split('T')[0]}.jsonl`,
        JSON.stringify(log) + '\n'
      );
    } catch (error) {
      console.error('Failed to write comparison log:', error);
    }
  }

  async getComparisonStats() {
    const recentLogs = this.logs.filter(
      log => Date.now() - log.timestamp.getTime() < 24 * 60 * 60 * 1000
    );

    const totalComparisons = recentLogs.length;
    const avgSimilarityDiff = recentLogs
      .filter(log => log.similarityDiff !== undefined)
      .reduce((sum, log) => sum + (log.similarityDiff || 0), 0) / totalComparisons;

    return {
      totalComparisons,
      avgSimilarityDiff,
      lastComparison: recentLogs[recentLogs.length - 1]?.timestamp
    };
  }
}

export const comparisonLogger = new ComparisonLogger();
```

### 4. Í¥ÄÎ¶¨Ïûê ÎåÄÏãúÎ≥¥Îìú

#### AI ÏÑúÎπÑÏä§ ÏÉÅÌÉú API
```typescript
// src/app/api/admin/ai-status/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { comparisonLogger } from '@/lib/comparison-logger';

export async function GET(request: NextRequest) {
  try {
    // InsightFace Î∞±ÏóîÎìú ÏÉÅÌÉú ÌôïÏù∏
    let insightFaceStatus = 'unknown';
    let insightFaceHealth = null;
    
    try {
      const response = await fetch(`${process.env.INSIGHT_FACE_API_URL}/health`, {
        signal: AbortSignal.timeout(5000)
      });
      insightFaceHealth = await response.json();
      insightFaceStatus = response.ok ? 'healthy' : 'unhealthy';
    } catch (error) {
      insightFaceStatus = 'unreachable';
    }

    // AWS ÏÉÅÌÉú (Í∞ÑÎã®Ìïú Ï≤¥ÌÅ¨)
    let awsStatus = 'unknown';
    try {
      // AWS SDKÎ°ú Í∞ÑÎã®Ìïú Ìò∏Ï∂ú ÌÖåÏä§Ìä∏
      awsStatus = 'healthy'; // Ïã§Ï†úÎ°úÎäî AWS API Ìò∏Ï∂ú ÌÖåÏä§Ìä∏
    } catch (error) {
      awsStatus = 'unhealthy';
    }

    // ÎπÑÍµê ÌÜµÍ≥Ñ
    const comparisonStats = await comparisonLogger.getComparisonStats();

    return NextResponse.json({
      timestamp: new Date().toISOString(),
      services: {
        insightface: {
          status: insightFaceStatus,
          health: insightFaceHealth,
          enabled: process.env.USE_INSIGHT_FACE === 'true'
        },
        aws: {
          status: awsStatus,
          enabled: process.env.USE_INSIGHT_FACE !== 'true' || process.env.FALLBACK_TO_AWS === 'true'
        }
      },
      configuration: {
        useInsightFace: process.env.USE_INSIGHT_FACE === 'true',
        fallbackToAWS: process.env.FALLBACK_TO_AWS === 'true',
        abTestRatio: parseFloat(process.env.A_B_TEST_RATIO || '0'),
        logComparison: process.env.LOG_COMPARISON === 'true'
      },
      comparisonStats
    });
  } catch (error) {
    console.error('Error in AI status API:', error);
    return NextResponse.json(
      { error: 'Failed to get AI status' },
      { status: 500 }
    );
  }
}
```

#### Í¥ÄÎ¶¨Ïûê ÌéòÏù¥ÏßÄ Ïª¥Ìè¨ÎÑåÌä∏
```typescript
// src/components/admin/AIServiceDashboard.tsx
'use client';

import React, { useState, useEffect } from 'react';

interface AIStatus {
  services: {
    insightface: {
      status: string;
      health?: any;
      enabled: boolean;
    };
    aws: {
      status: string;
      enabled: boolean;
    };
  };
  configuration: {
    useInsightFace: boolean;
    fallbackToAWS: boolean;
    abTestRatio: number;
    logComparison: boolean;
  };
  comparisonStats: {
    totalComparisons: number;
    avgSimilarityDiff: number;
    lastComparison?: string;
  };
}

export default function AIServiceDashboard() {
  const [status, setStatus] = useState<AIStatus | null>(null);
  const [loading, setLoading] = useState(true);

  const fetchStatus = async () => {
    try {
      const response = await fetch('/api/admin/ai-status');
      const data = await response.json();
      setStatus(data);
    } catch (error) {
      console.error('Failed to fetch AI status:', error);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchStatus();
    const interval = setInterval(fetchStatus, 30000); // 30Ï¥àÎßàÎã§ ÏóÖÎç∞Ïù¥Ìä∏
    return () => clearInterval(interval);
  }, []);

  if (loading || !status) {
    return <div className="p-6">Loading AI service status...</div>;
  }

  return (
    <div className="p-6 space-y-6">
      <h2 className="text-2xl font-bold">AI Service Dashboard</h2>
      
      {/* ÏÑúÎπÑÏä§ ÏÉÅÌÉú */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div className="bg-white p-4 rounded-lg shadow">
          <h3 className="text-lg font-semibold mb-2">InsightFace Backend</h3>
          <div className="space-y-2">
            <div className={`inline-block px-2 py-1 rounded text-sm ${
              status.services.insightface.status === 'healthy' ? 'bg-green-100 text-green-800' :
              status.services.insightface.status === 'unhealthy' ? 'bg-red-100 text-red-800' :
              'bg-gray-100 text-gray-800'
            }`}>
              {status.services.insightface.status}
            </div>
            <p className="text-sm">
              Enabled: {status.services.insightface.enabled ? 'Yes' : 'No'}
            </p>
            {status.services.insightface.health && (
              <div className="text-xs text-gray-600">
                <p>Memory: {status.services.insightface.health.memory_usage?.used_mb}MB / {status.services.insightface.health.memory_usage?.total_mb}MB</p>
                <p>GPU: {status.services.insightface.health.gpu_available ? 'Available' : 'Not Available'}</p>
              </div>
            )}
          </div>
        </div>

        <div className="bg-white p-4 rounded-lg shadow">
          <h3 className="text-lg font-semibold mb-2">AWS Rekognition</h3>
          <div className="space-y-2">
            <div className={`inline-block px-2 py-1 rounded text-sm ${
              status.services.aws.status === 'healthy' ? 'bg-green-100 text-green-800' :
              'bg-red-100 text-red-800'
            }`}>
              {status.services.aws.status}
            </div>
            <p className="text-sm">
              Enabled: {status.services.aws.enabled ? 'Yes' : 'No'}
            </p>
          </div>
        </div>
      </div>

      {/* ÏÑ§Ï†ï ÏÉÅÌÉú */}
      <div className="bg-white p-4 rounded-lg shadow">
        <h3 className="text-lg font-semibold mb-4">Configuration</h3>
        <div className="grid grid-cols-2 gap-4 text-sm">
          <div>
            <p><strong>Primary Service:</strong> {status.configuration.useInsightFace ? 'InsightFace' : 'AWS'}</p>
            <p><strong>Fallback:</strong> {status.configuration.fallbackToAWS ? 'Enabled' : 'Disabled'}</p>
          </div>
          <div>
            <p><strong>A/B Test Ratio:</strong> {(status.configuration.abTestRatio * 100).toFixed(1)}% InsightFace</p>
            <p><strong>Comparison Logging:</strong> {status.configuration.logComparison ? 'Enabled' : 'Disabled'}</p>
          </div>
        </div>
      </div>

      {/* ÎπÑÍµê ÌÜµÍ≥Ñ */}
      <div className="bg-white p-4 rounded-lg shadow">
        <h3 className="text-lg font-semibold mb-4">Comparison Statistics (24h)</h3>
        <div className="grid grid-cols-3 gap-4 text-sm">
          <div>
            <p className="text-gray-600">Total Comparisons</p>
            <p className="text-2xl font-bold">{status.comparisonStats.totalComparisons}</p>
          </div>
          <div>
            <p className="text-gray-600">Avg Similarity Difference</p>
            <p className="text-2xl font-bold">{status.comparisonStats.avgSimilarityDiff?.toFixed(2)}%</p>
          </div>
          <div>
            <p className="text-gray-600">Last Comparison</p>
            <p className="text-sm">{status.comparisonStats.lastComparison ? 
              new Date(status.comparisonStats.lastComparison).toLocaleString() : 'None'
            }</p>
          </div>
        </div>
      </div>

      {/* Ï†úÏñ¥ Î≤ÑÌäº */}
      <div className="bg-white p-4 rounded-lg shadow">
        <h3 className="text-lg font-semibold mb-4">Quick Actions</h3>
        <div className="space-x-2">
          <button className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
            Switch to InsightFace
          </button>
          <button className="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
            Switch to AWS
          </button>
          <button className="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600">
            Enable A/B Test
          </button>
          <button className="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600" onClick={fetchStatus}>
            Refresh Status
          </button>
        </div>
      </div>
    </div>
  );
}
```

## üß™ ÌÖåÏä§Ìä∏ Ï†ÑÎûµ

### 1. Í∏∞Îä• ÎèôÎì±ÏÑ± ÌÖåÏä§Ìä∏

```typescript
// tests/integration/ai-service-comparison.test.ts
import { compareFaces as awsCompareFaces } from '@/lib/aws/rekognition';
import { aiServiceRouter } from '@/lib/ai-service-router';

describe('AI Service Comparison', () => {
  const testImages = {
    person1: 'data:image/jpeg;base64,...',
    person2: 'data:image/jpeg;base64,...',
    samePerson: 'data:image/jpeg;base64,...'
  };

  test('Í∞ôÏùÄ ÏÇ¨Îûå ÎπÑÍµê - ÎÜíÏùÄ Ïú†ÏÇ¨ÎèÑ', async () => {
    // AWS Í≤∞Í≥º
    const awsResult = await awsCompareFaces(testImages.person1, testImages.samePerson);
    
    // InsightFace Í≤∞Í≥º (Í∞ïÏ†úÎ°ú InsightFace ÏÇ¨Ïö©)
    process.env.USE_INSIGHT_FACE = 'true';
    const insightFaceResult = await aiServiceRouter.compareFaces({
      sourceImage: testImages.person1,
      targetImage: testImages.samePerson
    });

    // Í≤∞Í≥º ÎπÑÍµê
    expect(awsResult.success).toBe(true);
    expect(insightFaceResult.success).toBe(true);
    
    const awsSimilarity = awsResult.data?.similarity || 0;
    const insightFaceSimilarity = insightFaceResult.data?.similarity || 0;
    
    // Ïú†ÏÇ¨ÎèÑ Ï∞®Ïù¥Í∞Ä 20% Ïù¥ÎÇ¥
    expect(Math.abs(awsSimilarity - insightFaceSimilarity)).toBeLessThan(20);
    
    // Îëò Îã§ ÎÜíÏùÄ Ïú†ÏÇ¨ÎèÑ (>70%)
    expect(awsSimilarity).toBeGreaterThan(70);
    expect(insightFaceSimilarity).toBeGreaterThan(70);
  });

  test('Îã§Î•∏ ÏÇ¨Îûå ÎπÑÍµê - ÎÇÆÏùÄ Ïú†ÏÇ¨ÎèÑ', async () => {
    const awsResult = await awsCompareFaces(testImages.person1, testImages.person2);
    
    process.env.USE_INSIGHT_FACE = 'true';
    const insightFaceResult = await aiServiceRouter.compareFaces({
      sourceImage: testImages.person1,
      targetImage: testImages.person2
    });

    const awsSimilarity = awsResult.data?.similarity || 0;
    const insightFaceSimilarity = insightFaceResult.data?.similarity || 0;
    
    // Îëò Îã§ ÎÇÆÏùÄ Ïú†ÏÇ¨ÎèÑ (<50%)
    expect(awsSimilarity).toBeLessThan(50);
    expect(insightFaceSimilarity).toBeLessThan(50);
  });
});
```

### 2. ÏÑ±Îä• ÌÖåÏä§Ìä∏

```typescript
// tests/performance/response-time.test.ts
describe('Response Time Comparison', () => {
  test('ÏùëÎãµ ÏãúÍ∞Ñ ÎπÑÍµê', async () => {
    const testImage1 = 'data:image/jpeg;base64,...';
    const testImage2 = 'data:image/jpeg;base64,...';

    // AWS ÏùëÎãµ ÏãúÍ∞Ñ Ï∏°Ï†ï
    const awsStart = Date.now();
    const awsResult = await awsCompareFaces(testImage1, testImage2);
    const awsTime = Date.now() - awsStart;

    // InsightFace ÏùëÎãµ ÏãúÍ∞Ñ Ï∏°Ï†ï
    process.env.USE_INSIGHT_FACE = 'true';
    const insightFaceStart = Date.now();
    const insightFaceResult = await aiServiceRouter.compareFaces({
      sourceImage: testImage1,
      targetImage: testImage2
    });
    const insightFaceTime = Date.now() - insightFaceStart;

    console.log(`AWS Response Time: ${awsTime}ms`);
    console.log(`InsightFace Response Time: ${insightFaceTime}ms`);

    // Îëò Îã§ 5Ï¥à Ïù¥ÎÇ¥ ÏùëÎãµ
    expect(awsTime).toBeLessThan(5000);
    expect(insightFaceTime).toBeLessThan(5000);
  });
});
```

## üìà Î∞∞Ìè¨ Í≥ÑÌöç

### 1. Îã®Í≥ÑÏ†Å Î∞∞Ìè¨

```bash
# Stage 1: Í∞úÎ∞úÌôòÍ≤Ω (Í∞úÎ∞úÏûêÎßå)
USE_INSIGHT_FACE=true
A_B_TEST_RATIO=0.0
FALLBACK_TO_AWS=true

# Stage 2: Î≤†ÌÉÄ ÌÖåÏä§Ìä∏ (10% ÏÇ¨Ïö©Ïûê)
USE_INSIGHT_FACE=false
A_B_TEST_RATIO=0.1
FALLBACK_TO_AWS=true

# Stage 3: ÌôïÏû• ÌÖåÏä§Ìä∏ (50% ÏÇ¨Ïö©Ïûê)
USE_INSIGHT_FACE=false
A_B_TEST_RATIO=0.5
FALLBACK_TO_AWS=true

# Stage 4: ÏôÑÏ†Ñ Ï†ÑÌôò (100% ÏÇ¨Ïö©Ïûê)
USE_INSIGHT_FACE=true
A_B_TEST_RATIO=1.0
FALLBACK_TO_AWS=true

# Stage 5: AWS Ï†úÍ±∞
USE_INSIGHT_FACE=true
FALLBACK_TO_AWS=false
```

### 2. Î°§Î∞± Í≥ÑÌöç

```bash
# Ï¶âÏãú Î°§Î∞± (Í∏¥Í∏âÏÉÅÌô©)
USE_INSIGHT_FACE=false
A_B_TEST_RATIO=0.0

# Ï†êÏßÑÏ†Å Î°§Î∞±
A_B_TEST_RATIO=0.5  # 50%Î°ú Í∞êÏÜå
A_B_TEST_RATIO=0.1  # 10%Î°ú Í∞êÏÜå
A_B_TEST_RATIO=0.0  # ÏôÑÏ†Ñ Î°§Î∞±
```

## üìä ÏÑ±Í≥µ ÏßÄÌëú

### 1. Í∏∞Îä• ÏßÄÌëú
- **Ï†ïÌôïÎèÑ**: InsightFace vs AWS Ïú†ÏÇ¨ÎèÑ Ï∞®Ïù¥ < 15%
- **ÏÑ±Í≥µÎ•†**: API ÏÑ±Í≥µÎ•† > 99%
- **ÏùëÎãµÏãúÍ∞Ñ**: ÌèâÍ∑† ÏùëÎãµÏãúÍ∞Ñ < 2Ï¥à

### 2. ÎπÑÏ¶àÎãàÏä§ ÏßÄÌëú  
- **ÏÇ¨Ïö©Ïûê ÎßåÏ°±ÎèÑ**: ÏÇ¨Ïö©Ïûê ÌîºÎìúÎ∞± Ï†êÏàò Ïú†ÏßÄ
- **ÏÑúÎπÑÏä§ Í∞ÄÏö©ÏÑ±**: 99.9% Ïù¥ÏÉÅ
- **ÎπÑÏö© Ï†àÍ∞ê**: 50% Ïù¥ÏÉÅ ÎπÑÏö© Ï†àÍ∞ê (Ïõî 10ÎßåÌöå Ïù¥ÏÉÅ Ïãú)

### 3. Í∏∞Ïà† ÏßÄÌëú
- **ÏóêÎü¨Ïú®**: < 1%
- **Ïû•Ïï† Î≥µÍµ¨ ÏãúÍ∞Ñ**: < 5Î∂Ñ
- **Î©îÎ™®Î¶¨ ÏÇ¨Ïö©Îüâ**: < 2GB

---

**ÏûëÏÑ±Ïùº**: 2025-09-19  
**Î≤ÑÏ†Ñ**: 1.0.0  
**ÏûëÏÑ±Ïûê**: AI Backend Team